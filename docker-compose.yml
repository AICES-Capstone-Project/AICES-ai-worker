version: "3.8"

services:
  redis:
    image: redis:7-alpine # Lightweight and stable Redis image
    container_name: aices_redis
    restart: unless-stopped # Auto-restart unless manually stopped
    ports:
      - "6379:6379" # Expose Redis port for backend access
    volumes:
      - redis-data:/data # Persist Redis data (optional but recommended)

  worker:
    build: . # Build from local Dockerfile
    container_name: aices_worker
    restart: unless-stopped
    depends_on:
      - redis # Ensure Redis is started before the worker
    environment:
      - REDIS_HOST=redis://10.250.0.2:6379 # Internal Redis hostname
      - BACKEND_API_URL=https://aices-api-632140981337.asia-southeast1.run.app/ # URL to post results back to .NET API
      - GEMINI_API_KEY=${AIzaSyAWI_RTQEJ22gVZnOhZT_XK_OQQsRtdL4k} # Loaded from .env
    logging:
      driver: "json-file" # Use JSON file logging
      options:
        max-size: "10m" # Prevent log files from growing too large
        max-file: "3" # Keep only 3 rotated logs

volumes:
  redis-data: # Volume for Redis persistence
